# Azure DevOps Pipeline - EquityReview
# Deploys to Azure Static Web App and Function App

trigger:
  branches:
    include:
      - main
      - dev
  paths:
    exclude:
      - README.md
      - docs/**
      - infrastructure/**

variables:
  # Environment-specific variables
  ${{ if eq(variables['Build.SourceBranchName'], 'main') }}:
    environmentName: 'dev'
    resourceGroup: 'rg-catalight-er-dev'
    staticWebAppName: 'catalight-er-swa-dev'
    functionAppName: 'catalight-er-func-dev'
  ${{ if eq(variables['Build.SourceBranchName'], 'dev') }}:
    environmentName: 'dev'
    resourceGroup: 'rg-catalight-er-dev'
    staticWebAppName: 'catalight-er-swa-dev'
    functionAppName: 'catalight-er-func-dev'

  # Build configuration
  nodeVersion: '20.x'
  buildConfiguration: 'production'

stages:
  - stage: Build
    displayName: 'Build Application'
    jobs:
      - job: BuildJob
        displayName: 'Build Frontend and Backend'
        pool:
          vmImage: 'ubuntu-latest'
        
        steps:
          - task: NodeTool@0
            displayName: 'Install Node.js'
            inputs:
              versionSpec: $(nodeVersion)
          
          - task: Cache@2
            displayName: 'Cache npm packages'
            inputs:
              key: 'npm | "$(Agent.OS)" | package-lock.json'
              path: '$(System.DefaultWorkingDirectory)/node_modules'
              restoreKeys: |
                npm | "$(Agent.OS)"
          
          - script: |
              npm ci
            displayName: 'Install dependencies'
          
          - script: |
              npm run build
            displayName: 'Build application'
            env:
              NODE_ENV: production
          
          # Archive build artifacts
          - task: ArchiveFiles@2
            displayName: 'Archive frontend build'
            inputs:
              rootFolderOrFile: '$(System.DefaultWorkingDirectory)/dist'
              includeRootFolder: false
              archiveType: 'zip'
              archiveFile: '$(Build.ArtifactStagingDirectory)/frontend-$(Build.BuildId).zip'
          
          # Publish artifacts
          - task: PublishBuildArtifacts@1
            displayName: 'Publish build artifacts'
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)'
              ArtifactName: 'drop'
              publishLocation: 'Container'

  - stage: DeployDev
    displayName: 'Deploy to Dev'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - deployment: DeployStaticWebApp
        displayName: 'Deploy to Azure Static Web App'
        environment: $(environmentName)
        pool:
          vmImage: 'ubuntu-latest'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: DownloadBuildArtifacts@0
                  displayName: 'Download build artifacts'
                  inputs:
                    buildType: 'current'
                    downloadType: 'single'
                    artifactName: 'drop'
                    downloadPath: '$(System.ArtifactsDirectory)'
                
                - task: AzureStaticWebApp@0
                  displayName: 'Deploy to Static Web App'
                  inputs:
                    app_location: '/'
                    api_location: ''
                    output_location: 'dist'
                    azure_static_web_apps_api_token: $(AZURE_STATIC_WEB_APPS_API_TOKEN)
                    skip_app_build: true

      - deployment: DeployFunctionApp
        displayName: 'Deploy to Azure Function App'
        environment: $(environmentName)
        pool:
          vmImage: 'ubuntu-latest'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: NodeTool@0
                  displayName: 'Install Node.js'
                  inputs:
                    versionSpec: $(nodeVersion)
                
                - checkout: self
                
                - script: |
                    cd server
                    npm ci --production
                  displayName: 'Install Function App dependencies'
                
                - task: AzureFunctionApp@2
                  displayName: 'Deploy Azure Function App'
                  inputs:
                    azureSubscription: 'Azure-ServiceConnection'
                    appType: 'functionAppLinux'
                    appName: $(functionAppName)
                    package: '$(System.DefaultWorkingDirectory)/server'
                    runtimeStack: 'NODE|20'
                    deploymentMethod: 'auto'

  - stage: ConfigureResources
    displayName: 'Configure Azure Resources'
    dependsOn: DeployDev
    condition: succeeded()
    jobs:
      - job: ConfigureAppSettings
        displayName: 'Update Function App Settings'
        pool:
          vmImage: 'ubuntu-latest'
        
        steps:
          - task: AzureCLI@2
            displayName: 'Configure Function App Settings'
            inputs:
              azureSubscription: 'Azure-ServiceConnection'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                # Update Function App settings
                az functionapp config appsettings set \
                  --name $(functionAppName) \
                  --resource-group $(resourceGroup) \
                  --settings \
                    COSMOS_DB_CONNECTION="@Microsoft.KeyVault(VaultName=catalight-er-kv-$(environmentName);SecretName=COSMOS-DB-CONNECTION)" \
                    COSMOS_DB_NAME="equityreview" \
                    AZURE_AD_TENANT_ID="$(AZURE_AD_TENANT_ID)" \
                    AZURE_AD_CLIENT_ID="$(AZURE_AD_CLIENT_ID)" \
                    NODE_ENV="production" \
                    APPLICATIONINSIGHTS_CONNECTION_STRING="$(APP_INSIGHTS_CONNECTION_STRING)"
                
                echo "Function App settings updated successfully"
          
          - task: AzureCLI@2
            displayName: 'Configure Static Web App Settings'
            inputs:
              azureSubscription: 'Azure-ServiceConnection'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                # Update Static Web App settings
                az staticwebapp appsettings set \
                  --name $(staticWebAppName) \
                  --resource-group $(resourceGroup) \
                  --setting-names \
                    AZURE_AD_CLIENT_ID="$(AZURE_AD_CLIENT_ID)" \
                    AZURE_AD_CLIENT_SECRET="@Microsoft.KeyVault(VaultName=catalight-er-kv-$(environmentName);SecretName=AZURE-AD-CLIENT-SECRET)"
                
                echo "Static Web App settings updated successfully"
