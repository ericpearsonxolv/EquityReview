trigger:
  branches:
    include:
      - main
      - develop
  paths:
    exclude:
      - '*.md'
      - 'docs/**'

pr:
  branches:
    include:
      - main
      - develop

pool:
  vmImage: 'ubuntu-latest'

variables:
  npm_config_cache: $(Pipeline.Workspace)/.npm
  NODE_VERSION: '20.x'
  AZURE_CONTAINER_REGISTRY: 'your-acr-name.azurecr.io'
  IMAGE_NAME: 'equityreview'

stages:
  - stage: Build
    displayName: 'Build & Test'
    jobs:
      - job: BuildAndTest
        displayName: 'Build, Lint, Test'
        steps:
          - checkout: self
            fetchDepth: 0

          - task: NodeTool@0
            inputs:
              versionSpec: $(NODE_VERSION)
            displayName: 'Install Node.js $(NODE_VERSION)'

          - task: Cache@2
            inputs:
              key: 'npm | "$(Agent.OS)" | package-lock.json'
              restoreKeys: |
                npm | "$(Agent.OS)"
              path: $(npm_config_cache)
            displayName: 'Cache npm packages'

          - script: npm ci
            displayName: 'Install dependencies'

          - script: npm run check
            displayName: 'TypeScript type check'
            continueOnError: false

          - script: npm run build
            displayName: 'Build application'

          - script: npm audit --audit-level=moderate
            displayName: 'Security audit'
            continueOnError: true

          - task: CopyFiles@2
            inputs:
              sourceFolder: '$(Build.SourcesDirectory)'
              contents: |
                dist/**
                server/**
                client/**
                shared/**
                package.json
                package-lock.json
                drizzle.config.ts
                tsconfig.json
                vite.config.ts
                tailwind.config.ts
                postcss.config.mjs
              targetFolder: '$(Build.ArtifactStagingDirectory)/app'
            displayName: 'Copy application files'

          - task: PublishBuildArtifacts@1
            inputs:
              pathToPublish: '$(Build.ArtifactStagingDirectory)/app'
              artifactName: 'app-dist'
            displayName: 'Publish build artifacts'

  - stage: BuildContainer
    displayName: 'Build Container Image'
    dependsOn: Build
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - job: DockerBuild
        displayName: 'Build and Push Docker Image'
        steps:
          - task: DownloadBuildArtifacts@0
            inputs:
              artifactName: 'app-dist'
              downloadPath: '$(Build.SourcesDirectory)'

          - task: Docker@2
            inputs:
              containerRegistry: 'AzureContainerRegistry'
              repository: '$(IMAGE_NAME)'
              command: 'buildAndPush'
              Dockerfile: '**/Dockerfile'
              tags: |
                $(Build.BuildId)
                latest
            displayName: 'Build and push Docker image'

  - stage: DeployDev
    displayName: 'Deploy to Development'
    dependsOn: BuildContainer
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/develop'))
    jobs:
      - deployment: DeployToDev
        displayName: 'Deploy to Dev Environment'
        environment: 'development'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: AzureWebAppContainer@1
                  inputs:
                    azureSubscription: 'Azure-Service-Connection'
                    appName: 'equityreview-dev'
                    containers: '$(AZURE_CONTAINER_REGISTRY)/$(IMAGE_NAME):$(Build.BuildId)'
                  displayName: 'Deploy to Azure App Service (Dev)'

  - stage: DeployProd
    displayName: 'Deploy to Production'
    dependsOn: BuildContainer
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - deployment: DeployToProd
        displayName: 'Deploy to Production Environment'
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: AzureWebAppContainer@1
                  inputs:
                    azureSubscription: 'Azure-Service-Connection'
                    appName: 'equityreview-prod'
                    containers: '$(AZURE_CONTAINER_REGISTRY)/$(IMAGE_NAME):$(Build.BuildId)'
                  displayName: 'Deploy to Azure App Service (Prod)'
